<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">

  <head>
	<meta name="generator" content="Hugo 0.49.2" />
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      PurpleScreen &middot; blog about open source
    
  </title>

  
  <link rel="stylesheet" href="https://purple-screen.com/css/poole.css">
  <link rel="stylesheet" href="https://purple-screen.com/css/syntax.css">
  <link rel="stylesheet" href="https://purple-screen.com/css/lanyon.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700|PT+Sans:400">
  <link rel="stylesheet" href="https://purple-screen.com/css/custom.css">
  
  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://purple-screen.com/assets/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="https://purple-screen.com/assets/favicon.png">

  
  <link rel="alternate" type="application/rss+xml" title="RSS" href="https://purple-screen.com/atom.xml">
</head>


  
  <body>

    
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">


<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p>Blog about IT</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item  active " href="https://purple-screen.com/">Home</a>
    <a class="sidebar-nav-item " href="https://purple-screen.com/post">Posts</a>

    
    
      
        <a class="sidebar-nav-item " href="https://purple-screen.com/about/">About</a>
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    

  </nav>

  <div class="sidebar-item">
    <p>Powered by <a href="https://gohugo.io/">Hugo</a>.</p>
    <p>Hosted on <a href="https://pages.github.com/">GitHub Pages</a> and <a href="https://cloudflare.com">CloudFlare</a>.</p>
    <p>&copy; 2014</p>
  </div>
</div>


    
    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="https://purple-screen.com/" title="Home">PurpleScreen</a>
            <small>blog about open source</small>
            
          </h3>
        </div>
      </div>

      <div class="container content">





<div class="posts">
  
    <div class="post">
        <h1 class="post-title"><a href="https://purple-screen.com/2013/10/27/esxcli-namespace-tree/">Esxcli namespace tree</a></h1>
        <span class="post-date">Oct 27 2013</span>
        <p>Every time a new ESXi version released I wonder what the functionality was added to <em>esxcli</em>. As you know all available namespaces and commands can be retrieved by typing <em>esxcli command list</em> in the console. To make the output look pretty I&#8217;ve written a couple of lines of PoSH code that generates the handy namespaces tree view.</p>

<pre class="lang:ps decode:true " title="esxcli" >$esxcli = Get-VMHost $Name | Get-EsxCli
$EsxcliNamespaceFile = [IO.File]::CreateText('D:\esxcli.txt')
$EsxcliNamespaceTree = $esxcli.esxcli.command.list()
$Commands = @()
foreach ($Namespace in $EsxcliNamespaceTree) {
    $Commands += @{Path = $Namespace.Namespace.Split('.'); Operation = $Namespace.Command }
}
 
function Expand-Tree ($Tree, $TabNum = 0) {
    $Tree | Group -Property {@($_.Path)[0]} | Sort Name | % {
        if ($_.Group.Path -eq $null) { $EsxcliNamespaceFile.Write(" $(($_.Group.Operation | Sort) -join ',')"); return }
        $EsxcliNamespaceFile.Write("`n$(if ($TabNum) { 1..$TabNum | % { "`t" } })$($_.Name)")
        $_.Group | % { $_.Path = $_.Path | Select -Skip 1 }
        Expand-Tree -Tree ($_.Group | Sort @{E={$_.Path.Count}}) -TabNum ($TabNum + 1)
    }
}
Expand-Tree -Tree $Commands
$EsxcliNamespaceFile.Close()</pre>

<p>The reason I&#8217;ve used the .NET class instead of Add-Content / Out-File cmdlets is that the latter append the new line.</p>

<p><a href="https://dl.dropboxusercontent.com/u/2398632/namespace.txt" title="EsxcliNamespaceTree" target="_blank">Here</a> is for the latest version 5.5.</p>

    </div>
  
    <div class="post">
        <h1 class="post-title"><a href="https://purple-screen.com/2013/09/29/omnitracker-automation/">OmniTracker automation</a></h1>
        <span class="post-date">Sep 29 2013</span>
        <p>Few words outside the virtualization world yet PoSH scripting related.</p>

<p>I&#8217;ve been working for a while in the company that uses <a href="http://www.omninet.de/index.php" title="Omnitracker" target="_blank">Omnitracker</a> as a helpdesk and incident management solution. Using its web interface as well as thick client isn&#8217;t the best experience. And when it comes to do it on a regular basis it turns to a nightmare especially for a scripting guy like me. So what should we do in this situation? Yep, exactly! Automate it!</p>

<p>As others the first thing I&#8217;ve tried is to call Google for help. What was my surprise when I saw nothing relevant at all in the first few pages except the Linkedin profile of a guy who should have the desired skills. Wow, the power of social networks in action! Take a challenge!</p>

<p>Looking through the manuals I&#8217;ve stumbled on the doc describing the automation interface. Good catch! C# there, so the PoSH isn&#8217;t far away. It turned out simple enough and after few tries I&#8217;ve managed to get it work. Couple of functions produced can be found below. As Omnitracker heavily relies on cusmomization most likely you won&#8217;t find it working in your environment but this functions should give you a tip how to handle the objects in OT.</p>

<pre class="lang:ps decode:true " title="OmniTracker" >function Set-OtTicket {
    [CmdletBinding()]
    Param (
        [Parameter(Mandatory)]
        [string[]] $TicketN,
        [Parameter(Mandatory)]
        [ValidateSet('Rejected','InfoRequest','InProgress','Solved')]
        [string] $Status,
        [string] $Server,
        [int] $Port = 5085,
        [System.Management.Automation.PSCredential] $Credential = Get-Credential,
        [string] $Folder
    )
    DynamicParam {
        switch -Regex ($Status) {
            'Rejected|InfoRequest' {
                Add-DynamicParam -ParameterName Comment -ParameterType string -Mandatory
            }
            'InProgress' {
                Add-DynamicParam -ParameterName EndDate -ParameterType DateTime -Mandatory |
                Add-DynamicParam -ParameterName Comment -ParameterType string
            }
            'Solved' {
                Add-DynamicParam -ParameterName Solution -ParameterType string -Mandatory `
                -Options @{ValidateNotNullOrEmpty = $null} |
                Add-DynamicParam -ParameterName Effort -ParameterType float -Mandatory |
                Add-DynamicParam -ParameterName Comment -ParameterType string
            }
        }
    }
    Begin {
        $otApp = New-Object -ComObject OtAut.OtApplication
        $otSession = $otApp.MakeSession($Server, $Port, $Credential.UserName, $Credential.GetNetworkCredential().Password)
    }
    Process {
        $otFolders = $otSession.RequestFolders
        $otFolder = ($otFolders | ? Path -eq $Folder)
        $otFilter = $otFolder.MakeFilter()
        $otFilter.SetSearchExpression("Number:I-$TicketN")
        $otFilter.Save()
        $otRequests = $otFolder.Search($otFilter, $true) # recursive
        $OtRequest = $otRequests.Item(0)
        $OtRequest.Unlock()
 
        $StatusHt = @{Rejected='Rejected'; InfoRequest='Запрос информации'}
 
        $State = $otRequest.UserFields | ? { $_.Definition.Label -eq 'State' }
        switch -Regex ($Status) {
            'Rejected|InfoRequest' {                
                $State.Value = $StatusHt.$Status
            }
            'InProgress' {
                $State.Value = 'In progress'
                $Terms = $otRequest.UserFields | ? { $_.Definition.Label -eq 'Срок решения' }
                $Terms.Value = $PSBoundParameters.EndDate.ToShortDateString()
            }
            'Solved' {
                $State.Value = 'In progress'
                $Terms = $otRequest.UserFields | ? { $_.Definition.Label -eq 'Срок решения' }
                $Terms.Value = (Get-Date).AddDays(1).ToShortDateString()
 
                $otRequest.Save($true, $null, $true)
 
                $Solution_ = $otRequest.UserFields | ? { $_.Definition.Label -eq 'Solution Description'}
                $Solution_.Value = $PSBoundParameters.Solution # formatted text
                $Effort_ = $otRequest.UserFields | ? { $_.Definition.Label -eq 'Effort'}
                $Effort_.Value = $PSBoundParameters.Effort
       
                $Terms.Value = (Get-Date).ToShortDateString()
                $State.Value = 'Solved'
            }
            '.*' {
                if ($PSBoundParameters.Comment) {
                    $Comments = $otRequest.UserFields | ? { $_.Definition.Label -eq 'Comments' }
                    $OtMemoSections = $Comments.TValue
                    $OtMemoSections.Add($PSBoundParameters.Comment)
                    $Comments.TValue = $OtMemoSections
                }
            }
        }
        $otRequest.Save($true, $null, $true)
    }
    End { $otSession.Logoff() }
}</pre>

    </div>
  
    <div class="post">
        <h1 class="post-title"><a href="https://purple-screen.com/2013/09/08/dynamic-parameters/">Dynamic parameters</a></h1>
        <span class="post-date">Sep 8 2013</span>
        <p>Today we gonna touch on dynamic parameters available in advanced functions. These are parameters that are added at run-time depending on the environment. The great example is the parameters that are dynamically exposed to the current parameter set of Get-Item cmdlet based on PS provider (FileSystem, Registry) used.</p>

<p>Faced it once you should have found out that simply adding such a parameter to the function means writing a bunch of code. Let&#8217;s make a life easier! I&#8217;d like to share with you short yet useful function I will actively utilize in my forthcoming scripts. Here it is:</p>

<pre class="expand:true lang:ps decode:true" title="Add-DynamicParam">function Add-DynamicParam {
    Param (
        [Parameter(ValueFromPipeline,HelpMessage='Dictionary to add created dynamic parameter')]
        [System.Management.Automation.RuntimeDefinedParameterDictionary] $ParamDictionary,
        [Parameter(Mandatory)]
        [string] $ParameterName,
        [Parameter(Mandatory)]
        [type] $ParameterType,
        [string[]] $ParameterSetName = '__AllParameterSets',
        [ValidateScript({
            $AcceptedValues = ('Alias','AllowNull','AllowEmptyString','AllowEmptyCollection',`
                               'ValidateCount','ValidateLength','ValidatePattern','ValidateRange',`
                               'ValidateScript','ValidateSet','ValidateNotNull','ValidateNotNullOrEmpty')
            -not (Compare @($_.Keys) $AcceptedValues | ? SideIndicator -eq '&lt;=')
        })]
        [hashtable] $Options,
        [int] $Position,
        [string] $HelpMessage,
        [switch] $ValueFromPipeline,
        [switch] $ValueFromPipelineByPropertyName,        
        [switch] $Mandatory
    )
    $ParamAttribute = [System.Management.Automation.ParameterAttribute]@{
        ParameterSetName = $ParameterSetName; Mandatory = $Mandatory.IsPresent;
        ValueFromPipeline = $ValueFromPipeline.IsPresent;
        ValueFromPipelineByPropertyName = $ValueFromPipelineByPropertyName.IsPresent
    }
    if ($HelpMessage) { $ParamAttribute.HelpMessage = $HelpMessage }
    if ($Position) { $ParamAttribute.Position = $Position }
    $ParamAttributeCollection = New-Object System.Collections.ObjectModel.Collection[System.Attribute]
    $ParamAttributeCollection.Add($ParamAttribute)
    if ($Options) {
        foreach ($Option in $Options.GetEnumerator()) {
            $ParamOptions = New-Object System.Management.Automation.$($Option.Name)Attribute -ArgumentList $Option.Value
            $ParamAttributeCollection.Add($ParamOptions)
        }
    }
    $Param = New-Object System.Management.Automation.RuntimeDefinedParameter($ParameterName, $ParameterType, $ParamAttributeCollection)
    if (-not $ParamDictionary) { $ParamDictionary = New-Object System.Management.Automation.RuntimeDefinedParameterDictionary }
    $ParamDictionary.Add($ParameterName, $Param)
    $ParamDictionary
}</pre>

<p>One note is that parameters created with this function are not available in script&#8217;s body using the parameter&#8217;s name but are exposed via $PSBoundParameters variable.</p>

<p>All the parameter attributes can be set by passing its values in hashtable to <em>-Options</em>. Other common attributes (&#8216;mandatory&#8217; switch, position, accepting values from pipeline) are also available. To add multiple dynamic parameters you should pipe one function call to another. Braindead simple! Here is an example:</p>

<pre class="expand:true lang:ps decode:true " title="DynamicParam usage">DynamicParam {
    if ($Status -eq 'Solved') {
        Add-DynamicParam -ParameterName Solution -ParameterType string -Mandatory -Options @{ValidateNotNullOrEmpty = $null} |
        Add-DynamicParam -ParameterName Effort -ParameterType int -Mandatory -Options @{ValidateSet = (1,2,3)}
    }
}
Process {
    $PSBoundParameters.Solution; $PSBoundParameters.Effort
}</pre>

    </div>
  
    <div class="post">
        <h1 class="post-title"><a href="https://purple-screen.com/2013/07/21/enumerating-through-hashtable-in-posh/">Enumerating through hashtable in PoSH</a></h1>
        <span class="post-date">Jul 21 2013</span>
        <pre class="expand:true lang:ps decode:true " >$ht = @{a=1; b=2; c=3}
$ht.GetEnumerator() | % { $_.key; $_.value }</pre>

    </div>
  
    <div class="post">
        <h1 class="post-title"><a href="https://purple-screen.com/2013/07/20/join-object/">Join-Object</a></h1>
        <span class="post-date">Jul 20 2013</span>
        <p>If you ever wrote SQL queries and now use PowerShell for scripting maybe you missed &#8216;Join&#8217; possibility in PoSH. Here it is!</p>

<p>Nothing special. I just tried to create Join-Object with the same functionality as inner/outer Join statements in SQL. My version of Join-Object uses standalone Merge-Object function for merging 2 arrays of custom objects / hashtables. Resulting object is an array of objects that contains all properties from joined objects except the ones with the same name, which are discarded. If you also want to include the property on which you join the collections use $IncludeJoinProperty switch. The expression for specifying the property to join on is that simple:</p>

<p><code>-On {$Left.'propertyName' -eq $Right.'propertyName'}</code></p>

<p>Collections to be joined must contain objects of the same type otherwise the error is generated. Also function throws an error in case of the values of join property in collection (left or right) are not unique. Merge and Join aliases added by default.</p>

<p>If you have any questions drop me a line in comments. Use it on your own risk :)</p>

<script type="application/javascript" src="//gist.github.com/akamac/ab449697d8f1cf57db8b149752062dfd.js"></script>

    </div>
  
    <div class="post">
        <h1 class="post-title"><a href="https://purple-screen.com/2013/07/19/must-read-posh-book/">Must read PoSH book</a></h1>
        <span class="post-date">Jul 19 2013</span>
        <p>If you start learning PowerShell then reading <a href="http://www.amazon.com/Windows-PowerShell-Action-Second-Edition/dp/1935182137" title="Windows PowerShell in Action, 2nd Edition" target="_blank">Windows PowerShell in Action, 2nd Edition</a> by Bruce Payette is a must! He is among the principal members of PowerShell team and explain guts of the language in detail.</p>

<p>Again, MUST READ!</p>

    </div>
  
    <div class="post">
        <h1 class="post-title"><a href="https://purple-screen.com/2013/06/15/foreach-cmdlet-vs-keyword/">ForEach: cmdlet vs keyword</a></h1>
        <span class="post-date">Jun 15 2013</span>
        <p>Here is a little note about the difference of these two loop constructions.</p>

<p><em>foreach</em> is a reserved keyword in PoSH that allows you to loop through collection of objects and make some action on every item. Inside the foreach loop <em>$foreach</em> automatic variable is available. It presents the loop enumerator and can be used, for instance, to skip the current object in collection (.MoveNext() method).</p>

<p><em>ForEach-Object</em> is a cmdlet doing almost the same thing but the difference is the usecase. Since the collection is piped to the cmdlet the objects are pushed down the pipeline as soon as they are generated. It affects the performance greatly when a collection isn&#8217;t created at the start of processing. When the last is long-time operation using the cmdlet you can achieve much better overall performance than using its brother-keyword. In other case one should consider using the keyword for higher execution speed.</p>

<p>Since both have the same alias foreach the PoSH parser is smart enough to select the appropriate construction depending on the place it is used.</p>

    </div>
  
    <div class="post">
        <h1 class="post-title"><a href="https://purple-screen.com/2013/05/31/vmware-uuids/">VMware UUIDs</a></h1>
        <span class="post-date">May 31 2013</span>
        <p>Hi everybody! My first post is about UUIDs &#8211; identifiers used for virtual machines in vSphere infrastructure. If you ever looked in vm config file (*.vmx) you could see 3 different lines containing 128-bit hex numbers. They are:</p>

<ul>
<li>uuid.bios</li>
<li>uuid.location</li>
<li>vc.uuid</li>
</ul>

<p>Because of having some issues with software licensing inside guest OS I decided to explore what the every value is responsible for. Web hasn&#8217;t gave me the complete answer about the meaning of all of these parameters so my investigations led me to the following conclusion I&#8217;d like to share with you.</p>

<p><strong>uuid.bios</strong> &#8211; this value acts as GUID analog in physical machine, you should keep it to make the license not to get broken. If you want to export VM, for example using vCenter Converter, and run it in VMware Player/Workstation you should also add the following line to exported vmx file together with copying the source uuid.bios value:</p>

<p><span style="padding-left: 10%"><em>uuid.action = &#8220;keep&#8221;</em></span></p>

<p>It prevents player/workstation from asking whether you moved or copied VM with default answer &#8220;I moved it&#8221;. If the valid uuid.bios line is present in config file it will be preserved and the software license will be OK. Another option for uuid.action is &#8220;change&#8221;. In this case VMware will generate the value when you power on VM in new location (host or even folder). You can read <a href="http://kb.vmware.com/selfservice/microsites/search.do?language=en_US&amp;cmd=displayKC&amp;externalId=1541">this KB article</a> to learn more about it. So the uuid.bios setting is done. Let&#8217;s look through others two.</p>

<p><strong>uuid.location</strong> is generated every time VM is vMotion&#8217;ed to another host/storage. I guess it&#8217;s used by vCenter for some internal purposes like ..</p>

<p><strong>vc.uuid</strong> is used by vCenter to identify VM together with MoRef ID you&#8217;ve seen while working with PowerCLI. It&#8217;s unique and is generated when you add VM to inventory (or create VM). If the value is already present in config file (and there is no duplicate in current inventory) it&#8217;s left intact.</p>

<p>That&#8217;s enough for the first post. In the end &#8211; a little piece of PowerShell code to automate the postprocessing of exported VM to ensure its uuid.bios value is the same as source vm&#8217;s. It guarantees the persistence of all licenses that depends on GUID.</p>

<p>Stay tuned, keep learning!</p>

    </div>
  
</div>

<div class="pagination">
  
  <span class="pagination-item older">Older</span>
  

  
  <a class="pagination-item newer" href="https://purple-screen.com/">Newer</a>
  
</div>

      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>
  </body>
</html>

